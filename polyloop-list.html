<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-datatable/paper-datatable-card.html">
<link rel="import" href="../paper-datatable/paper-datatable.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<!--
`polyloop-list`
Webcomponent to display list of records based on model schema.

@demo demo/polyloop-list.html
-->
<dom-module id="polyloop-list">
    <template>
        <style>
            :host {
                display: block;
            }
            
            paper-material {
                border-radius: 2px;
                background: white;
                @apply(--paper-datatable-card);
            }
            
            #selectionToolbar {
                display: none;
                background: var(--paper-datatable-selection-toolbar-color, --paper-pink-50);
                @apply(--paper-datatable-selection-toolbar);
                padding: 0px 12px 0px 24px;
            }
            
            #selectionToolbar .selectionHeader,
            #selectionToolbar .toolbar::content paper-icon-button {
                color: var(--paper-datatable-selection-toolbar-text-color, --accent-color);
            }
            
            #selectionToolbar[data-visible] {
                display: flex;
            }
            
            #selectionToolbar .toolbar {
                display: none;
            }
            
            #selectionToolbar .toolbar[data-visible] {
                display: flex;
            }
            
            #toolbar-main {
                padding-right: 12px;
            }
            
            #topBlock {
                height: 64px;
                padding: 0px 6px 0px 24px;
                position: relative;
                @apply(--paper-datatable-top-toolbar);
            }
            
            #topBlock .header {
                font-size: 20px;
                @apply(--paper-font-common-base);
                color: var(--paper-datatable-top-toolbar-text-color);
            }
            
            #selectionToolbar >::content paper-icon-button,
            .toolbar >::content paper-icon-button,
            #selectionToolbar >::content paper-icon,
            .toolbar >::content paper-icon,
            #selectionToolbar >::content iron-icon,
            .toolbar >::content iron-icon {
                color: var(--paper-datatable-selection-toolbar-icon-color, rgba(0, 0, 0, .54));
            }
            
            #toolbar-main::content paper-icon-button,
            #toolbar-main::content paper-icon,
            #toolbar-main::content iron-icon {
                color: var(--paper-datatable-top-toolbar-icon-color);
            }
            
            #topBlock .selectionHeader {
                font-size: 16px;
                @apply(--paper-font-common-base);
            }
            
            #bottomBlock {
                height: 56px;
                padding: 0px 6px;
                border-top: 1px solid var(--paper-datatable-divider-color, --divider-color);
                color: var(--paper-datatable-navigation-bar-text-color, rgba(0, 0, 0, .54));
                align-items: center;
                font-size: 12px;
                text-align: center;
                font-weight: 500;
                @apply(--paper-datatable-navigation-bar);
            }
            
            #bottomBlock paper-dropdown-menu {
                vertical-align: middle;
                --paper-input-container-underline: {
                    display: none;
                }
                ;
                --paper-input-container-input: {
                    text-align: right;
                    font-size: 12px;
                    font-weight: 500;
                    color: var(--paper-datatable-navigation-bar-text-color, rgba(0, 0, 0, .54));
                }
                ;
                --paper-dropdown-menu-icon: {
                    color: var(--paper-datatable-navigation-bar-text-color, rgba(0, 0, 0, .54));
                }
                ;
                margin-right: 18px;
            }
        </style>
        <h2>[[modelSchema.plural]]</h2>
        <paper-datatable data="{{_modelEntries}}" id="records">
            <template is="dom-repeat" items="{{_modelProperties}}" as="field">
                <paper-datatable-column header="{{field.name}}" sortable editable=false>
                    <template> {{_getValue(item, field.name)}} </template>
                </paper-datatable-column>
            </template>
        </paper-datatable>
        <paper-material>
            <div class="horizontal center layout" id="bottomBlock">
                <div class="flex"></div> <span>Rows per page:</span>
                <paper-dropdown-menu no-label-float style="width: 68px;">
                    <paper-menu class="dropdown-content" selected="{{pageSize}}" attr-for-selected="value">
                        <template is="dom-repeat" items="{{pageSizeOptions}}">
                            <paper-item value="{{item}}">{{item}}</paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu> <span>
					<span>[[_getRangeStart(page, pageSize)]]</span>-<span>[[_getRangeEnd(page, pageSize, numberOfItems)]]</span> of&nbsp;<span>[[numberOfItems]]</span> </span>
                <paper-icon-button icon="datatable:first-page" on-tap="firstPage" disabled="[[_prevPageDisabled(page)]]"></paper-icon-button>
                <paper-icon-button icon="datatable:prev-page" on-tap="prevPage" disabled="[[_prevPageDisabled(page)]]"></paper-icon-button>
                <paper-icon-button icon="datatable:next-page" on-tap="nextPage" disabled="[[_nextPageDisabled(page, pageSize, numberOfItems)]]"></paper-icon-button>
                <paper-icon-button icon="datatable:last-page" on-tap="lastPage" disabled="[[_nextPageDisabled(page, pageSize, numberOfItems)]]"></paper-icon-button>
            </div>
        </paper-material>
        <iron-ajax url="{{modelDefinitionEndPoint}}/ModelDefinitions/{{modelName}}" id="getModelDefinition" last-response="{{modelSchema}}" handle-as="json" on-response="_setModelProperties"> </iron-ajax>
        <iron-ajax url="{{modelDefinitionEndPoint}}/{{modelSchema.plural}}/count" id="getModelCount" handle-as="json" last-response="{{_modelCount}}"> </iron-ajax>
        <iron-ajax url="{{modelDefinitionEndPoint}}/{{modelSchema.plural}}?filter=%7B%22limit%22%3A{{pageSize}}%2C%22skip%22%3A[[_getRangeStart(page, pageSize)]]%7D" id="getModelEntries" last-response="{{_modelEntries}}" handle-as="json" on-response="_setModelEntries "> </iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'polyloop-list'
            , properties: {
                modelName: {
                    type: String
                    , value: 'ModelDefinition'
                }
                , modelDefinitionEndPoint: {
                    type: String
                }
                , _modelProperties: {
                    type: Object
                    , notify: true
                }
                , _modelEntries: {
                    type: Object
                    , notify: true
                }
                , _modelCount: {
                    type: Object
                    , notify: true
                }
                , pageSize: {
                    type: Number
                    , value: 5
                    , notify: true
                }
                , page: {
                    type: Number
                    , value: 1
                    , notify: true
                }
                , pageSizeOptions: {
                    type: Array
                    , value: [5, 10, 25, 100]
                    , notify: true
                }
                , _disableSave: {
                    type: Boolean
                    , value: false
                }
                , _datatable: {
                    type: Object
                }
            }
            , observers: [
                    '_getRangeStart()'
					, '_setNumberOfItems(_modelCount.count)'
				]
            , ready: function () {
                this.skip_page_content = 0;
                console.log('In ready model name = ', this.modelName);
                this.$.getModelDefinition.generateRequest();
            }
            , _toArray: function (obj) {
                //                console.log('toArray function called for -', obj);
                var array = Object.keys(obj).map(function (key) {
                    return {
                        name: key
                        , type: obj[key].type
                        , value: ''
                    }
                });
                //                console.log('Array = ', array);
                return array;
            }
            , _getValue: function (record, field) {
                //                console.log('getValue called... -', record);
                return record[field] || '_';
            }
            , _setModelProperties: function (event) {
                this.modelSchema = event.detail.response;
                this._modelProperties = this._toArray(this.modelSchema.properties);
                this.$.getModelCount.generateRequest();
                this.$.getModelEntries.generateRequest();
            }
            , _setModelEntries: function (event) {
                console.log(event);
                this._modelEntries = event.detail.response;
            }
            , _getRangeStart: function () {
                return (this.page - 1) * this.pageSize;
            }
            , _getRangeEnd: function () {
                this.$.getModelEntries.generateRequest();
                return Math.min((this.page) * this.pageSize, this.numberOfItems);
            }
            , _setNumberOfItems: function () {
                this.set('numberOfItems', this._modelCount.count);
            }
            , /**
             * Navigate to the next page
             */
            nextPage: function () {
                this.set("page", this.page + 1);
                this.$.getModelEntries.generateRequest();
            }
            , /**
             * Navigate to the previous page
             */
            prevPage: function () {
                this.set("page", this.page - 1);
                this.$.getModelEntries.generateRequest();
            }
            , /**
             * Navigate to the first page
             */
            firstPage: function () {
                this.set("page", 1);
                this.$.getModelEntries.generateRequest();
            }
            , /**
             * Navigate to the last page
             */
            lastPage: function () {
                this.set("page", Math.ceil(this.numberOfItems / this.pageSize));
                this.$.getModelEntries.generateRequest();
            }
            , _prevPageDisabled: function () {
                return this.page == 1;
            }
            , _nextPageDisabled: function () {
                return this.page * this.pageSize >= this.numberOfItems;
            }
        });
    </script>
</dom-module>